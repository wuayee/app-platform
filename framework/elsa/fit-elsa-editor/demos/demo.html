<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <style>
        .simple-box {
            padding: 10px;
            margin: 1em 0;

            background: rgba(0, 0, 0, 0.1);
            border: solid 1px hsl(0, 0%, 77%);
            border-radius: 2px;
        }

        .simple-box-title, .simple-box-description {
            padding: 10px;
            margin: 0;

            background: #FFF;
            border: solid 1px hsl(0, 0%, 77%);
        }

        .simple-box-title {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div>
    <button id="111" style="width: 100px;height: 100px;background: whitesmoke">reset</button>
    <button id="resetRight" style="width: 100px;height: 100px;background: whitesmoke">resetRight</button>
    <button id="222" style="width: 100px;height: 100px;background: whitesmoke">switchReadonly</button>
    <button id="333" style="width: 100px;height: 100px;background: whitesmoke">deregisterEditable</button>
    <button id="444" style="width: 100px;height: 100px;background: whitesmoke">removeDataListener</button>
    <button id="555" style="width: 100px;height: 100px;background: whitesmoke">removeSelectionListener</button>
    <button id="666" style="width: 100px;height: 100px;background: whitesmoke">attribute</button>
    <button id="777" style="width: 100px;height: 100px;background: whitesmoke">print attributes</button>
    <button id="888" style="width: 100px;height: 100px;background: whitesmoke">font family</button>
    <button id="999" style="width: 100px;height: 100px;background: whitesmoke">align</button>
    <button id="1111" style="width: 100px;height: 100px;background: whitesmoke">shape</button>
    <button id="2222" style="width: 100px;height: 100px;background: whitesmoke">shapeResize</button>
    <div id="document-toolbar"></div>
    <div id="container" style="display: flex">
        <div style="width: 960px; margin: 0 auto; background: white; height: calc(100vh);outline: none;white-space:pre-line"
             id="document-editable">
            "大纲：\n\nI. 引言\n   A. 介绍《陈情表》的背景和作者\n   B. 提出文章的主题：李密的《陈情表》如何反映当时社会的状况\n\nII. 李密的个人情况\n   A. 李密的生平简介\n   B. 李密的官职和地位\n   C. 李密的家庭背景\n\nIII. 《陈情表》的内容\n   A. 《陈情表》的主要内容概述\n   B. 《陈情表》中李密的个人情感和态度\n   C. 《陈情表》中李密对社会状况的描述和分析\n\nIV. 《陈情表》的社会背景\n   A. 当时的社会状况和政治环境\n   B. 当时的社会风气和道德观念\n   C. 当时的社会矛盾和问题\n\nV. 《陈情表》的影响和意义\n   A. 《陈情表》在文学史上的地位和影响\n   B. 《陈情表》对后世的影响和启示\n   C. 《陈情表》对现代社会的启示和借鉴\n\n详细解释：\n大纲中的每一部分都围绕着文章的主题展开，即李密的《陈情表》如何反映当时社会的状况。在引言部分，我们首先介绍了《陈情表》的背景和作者，然后提出了文章的主题。在李密的个人情况部分，我们介绍了李密的生平简介、官职和地位以及家庭背景，这些信息有助于我们理解李密的个人情感和态度。在《陈情表》的内容部分，我们概述了《陈情表》的主要内容，描述了李密的个人情感和态度，以及他对社会状况的描述和分析。在《陈情表》的社会背景部分，我们介绍了当时的社会状况和政治环境，社会风气和道德观念，以及社会矛盾和问题。在《陈情表》的影响和意义部分，我们讨论了《陈情表》在文学史上的地位和影响，对后世的影响和启示，以及对现代社会的启示和借鉴。"
        </div>
        <div style="width: 960px; margin: 0 auto; background: white; height: calc(100vh);outline: none"
             id="document-2"></div>
    </div>
</div>

<script type="module">
    import ElsaEditor from "../build/elsa-editor.js";

    const listItemData = [{
        attributes: {listType: "bulleted", listIndent: 0, listStyle: "default"},
        name: "listItem",
        children: [{data: "The descripti\r\non goes here"},
            {name: "shape", attributes: {id: "12345", width: "200px", height: "200px"}}]
    }];

    const paragraphData = [{
        name: "paragraph", children: [{data: "111111111111111111111"}]
    }];

    window.onload = () => {
        const simpleData = [{
            "attributes": {
                "id": "5"
            }, "name": "paragraph", "children": [{
                "data": "dfslkdfjlskjfklsdafjlk1"
            }], "x": 481.09, "y": 350.06, "width": 940.81, "height": 53
        }];

        document.getElementById("111").addEventListener("mousedown", (e) => {
            e.preventDefault();
            e.stopPropagation();
            const htmlData = '<p id="102">Some text.</p><p id="103">asdfklja<i><s><strong><u>skdlfjaslkfjas</u></strong></s></i>klfjsd</p><p id="104">sadflkasjdfklsjflk1</p>';
            window.editor.setData({test1: htmlData});
            // window.editor.data.init(data);
        });

        document.getElementById("resetRight").addEventListener("mousedown", () => {
            const htmlData = '<p id="102">Some text.</p><p id="103">asdfklja<i><s><strong><u>skdlfjaslkfjas</u></strong></s></i>klfjsd</p><p id="104">sadflkasjdfklsjflk1</p>';
            window.editor.setData({test2: htmlData});
        });

        document.getElementById("1111").addEventListener("mousedown", (e) => {
            // data[0].level = 1;
            e.preventDefault();
            window.editor.execute("shape", {value: {externalId: "1111", size: {width: "100px", height: "100px"}}});
        });

        document.getElementById("222").addEventListener("click", () => {
            const editor = window.editor;
            const lockId = "document-editable";
            if (editor._readOnlyLocks.has(lockId)) {
                window.editor.disableReadOnlyMode(lockId);
            } else {
                window.editor.enableReadOnlyMode(lockId);
            }
        });

        document.getElementById("2222").addEventListener("mousedown", (e) => {
            // data[0].level = 1;
            e.preventDefault();
            window.editor.execute("resizeShape", {value: {width: "300px", height: "300px"}});
        });

        document.getElementById("333").addEventListener("click", () => {
            window.editor.deregisterRoot("test1");
        });

        document.getElementById("444").addEventListener("click", () => {
            window.editor.removeDataListener("test1");
        });

        document.getElementById("555").addEventListener("click", () => {
            window.editor.removeSelectionListener();
        });

        document.getElementById("666").addEventListener("click", () => {
            const editor = window.editor;

            const model = editor.model;
            const document = editor.model.document;
            const selection = document.selection;
            let hasOwnRange = selection.hasOwnRange;

            if (!hasOwnRange) {
                const range = model.createRangeIn(model.document.getRoot("test1"));
                model.document.selection._setTo(range);
            }

            try {
                editor.execute("fontSize", {value: "44px"});
            } finally {
                if (!hasOwnRange) {
                    model.document.selection._setTo(null);
                }
            }
        });

        document.getElementById("777").addEventListener("click", () => {
            const editor = window.editor;
            const model = editor.model;
            const document = editor.model.document;
            const selection = document.selection;
            const hasOwnRange = selection.hasOwnRange;
            const command = editor.commands.get("fontSize");
            try {
                if (!hasOwnRange) {
                    const range = model.createRangeIn(model.document.getRoot("test1"));
                    editor.model.enqueueChange({isUndoable: false}, writer => {
                        editor.ignoreSelectionChange = true;
                        try {
                            writer.setSelection(range);
                        } finally {
                            editor.ignoreSelectionChange = false;
                        }
                    });
                    command.refresh();
                }
                console.log("attribute value: " + command.value);
            } finally {
                if (!hasOwnRange) {
                    editor.model.enqueueChange({isUndoable: false}, writer => {
                        editor.ignoreSelectionChange = true;
                        try {
                            writer.setSelection(null)
                        } finally {
                            editor.ignoreSelectionChange = false;
                        }
                    });
                    command.refresh();
                }
            }
        });

        document.getElementById("888").addEventListener("click", () => {
            const editor = window.editor;
            const model = editor.model;
            const document = editor.model.document;
            const selection = document.selection;
            const hasOwnRange = selection.hasOwnRange;
            try {
                if (!hasOwnRange) {
                    const range = model.createRangeIn(model.document.getRoot("test1"));
                    editor.model.enqueueChange({isUndoable: false}, writer => {
                        editor.ignoreSelectionChange = true;
                        try {
                            writer.setSelection(range);
                        } finally {
                            editor.ignoreSelectionChange = false;
                        }
                    });
                }
                editor.execute("fontFamily", {value: "SimHei"});
            } finally {
                if (!hasOwnRange) {
                    editor.model.enqueueChange({isUndoable: false}, writer => {
                        editor.ignoreSelectionChange = true;
                        try {
                            writer.setSelection(null)
                        } finally {
                            editor.ignoreSelectionChange = false;
                        }
                    });
                }
            }
        });

        document.getElementById("999").addEventListener("click", () => {
            const editor = window.editor;
            const model = editor.model;
            const document = editor.model.document;
            const selection = document.selection;
            const hasOwnRange = selection.hasOwnRange;
            try {
                if (!hasOwnRange) {
                    const range = model.createRangeIn(model.document.getRoot("test1"));
                    editor.model.enqueueChange({isUndoable: false}, writer => {
                        editor.ignoreSelectionChange = true;
                        try {
                            writer.setSelection(range);
                        } finally {
                            editor.ignoreSelectionChange = false;
                        }
                    });
                }
                editor.execute("alignment", {value: "center"});
            } finally {
                if (!hasOwnRange) {
                    editor.model.enqueueChange({isUndoable: false}, writer => {
                        editor.ignoreSelectionChange = true;
                        try {
                            writer.setSelection(null)
                        } finally {
                            editor.ignoreSelectionChange = false;
                        }
                    });
                }
            }
        });

        document.onkeydown = e => {
            if ((e.ctrlKey || e.metaKey) && (e.code === "KeyS")) {
                e.preventDefault();
                window.editor.setData({test1: simpleData});
            }
        }

        function getDropViewRange(domEvent) {
            const domDoc = domEvent.target.ownerDocument;
            const x = domEvent.clientX;
            const y = domEvent.clientY;
            let domRange;

            // Webkit & Blink.
            if (domDoc.caretRangeFromPoint && domDoc.caretRangeFromPoint(x, y)) {
                domRange = domDoc.caretRangeFromPoint(x, y);
            }
            // FF.
            else if (domEvent.rangeParent) {
                domRange = domDoc.createRange();
                domRange.setStart(domEvent.rangeParent, domEvent.rangeOffset);
                domRange.collapse(true);
            }

            if (domRange) {
                return window.editor.editing.view.domConverter.domRangeToView(domRange);
            }

            return null;
        }

        const count = 0;
        const container = document.getElementById("container");
        for (let i = 0; i < count; i++) {
            const div = document.createElement("div");
            div.id = "document" + (i + 100);
            container.appendChild(div);
        }

        let readOnly = false;

        let id = 100;
        ElsaEditor.create({}, {generateId: () => id++ + ""})
            .then(editor => {
                window.editor = editor;
                editor.renderToolbar(document.getElementById("document-toolbar"));
                editor.registerRoot("test1", document.getElementById("document-editable"));
                editor.registerRoot("test2", document.getElementById("document-2"));

                for (let i = 0; i < count; i++) {
                    editor.registerRoot("test" + (i + 100), document.getElementById("document" + (i + 100)));
                }

                if (readOnly) {
                    editor.enableReadOnlyMode("document-editable");
                } else {
                    editor.addDataListener("test1", (prevData, data) => {
                        console.log(data);
                        // console.log("test1发生变化");
                    });

                    editor.addDataListener("test2", (prevData, data) => {
                        console.log(data);
                        // console.log("test1发生变化");
                    });
                    //
                    // editor.addDataListener("test2", (prevData, data) => {
                    //     console.log(JSON.stringify(data));
                    //     console.log("test2发生变化");
                    // });

                    // editor.addSelectionListener((args, args1) => {
                    //     if (editor.ignoreSelectionChange) {
                    //         return;
                    //     }
                    //     console.log("选区发生了变化.");
                    // });
                }

                // const startTime = new Date().getTime();
                // editor.setData({test1: listItemData});
                // const endTime = new Date().getTime();
                // console.log("render text cost:", endTime - startTime);

                // editor.setData({
                //     test2: [{
                //         "attributes": {
                //             "id": "3"
                //         }, "name": "paragraph", "children": [{
                //             "data": "The description goes here"
                //         }], "x": 481.09, "y": 266.63, "width": 940.81, "height": 53
                //     }]
                // });

                for (let i = 0; i < count; i++) {
                    const dataTmp = {};
                    const name = "test" + (i + 100);
                    dataTmp[name] = simpleData;
                    editor.setData(dataTmp);
                }

                // focus相关.
                editor.editing.view.focus();

                editor.commands.get("delete").on("execute", (eventInfo, args) => {
                    // const selection = editor.model.document.selection;
                    // if (selection.isCollapsed) {
                    //     const selectedBlocks = Array.from(selection.getSelectedBlocks());
                    //
                    // }
                    // eventInfo.stop();
                    // console.log(eventInfo);
                    // console.log(args);
                    // console.log(editor.model.document.selection);
                }, {priority: "high"});

                editor.model.on("deleteContent", (eventInfo, args) => {
                    // eventInfo.stop();
                    // console.log(eventInfo);
                    // console.log(args);
                }, {priority: "high"});

                editor.model.document.selection.on("change:attribute", (eventInfo, args) => {
                    // console.log("change:attribute");
                    // console.log(args);
                    // const selection = editor.model.document.selection;
                    // console.log(selection);
                });

                editor.model.document.selection.on("change", (eventInfo, args) => {
                    // console.log(eventInfo);
                    // console.log(args);
                });

                // editor.editing.view.document.selection.on('change', (...args) => {
                //     console.log(editor.editing.view.document.selection);
                //     console.log(args);
                // });
                // console.log("isFocused: ", editor.editing.view.document.isFocused);
                // console.log(document.getElementById("document-editable").contains(document.activeElement));

                editor.editing.view.document.on("mousedown", (evtInfo, domEvtData) => {
                    // const viewRange = getDropViewRange(domEvtData.domEvent);
                    // console.log(viewRange);
                });

                editor.editing.view.document.on("paste", (eventInfo, data) => {
                    console.log("clipboardInput=========================");
                    console.log(editor);
                }, {priority: 'lowest'});
            })
            .catch(error => {
                console.error('There was a problem initializing the editor.', error);
            });

        document.getElementById("document-editable").innerHTML = '<p id="102">Some text.</p><p id="103">asdfklja<i><s><strong><u>skdlfjaslkfjas</u></strong></s></i>klfjsd</p><p id="104">sadflkasjdfklsjflk1</p>';
    }
</script>
</body>
</html>