<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>dynamicForm-Demo</title>


    <script type="module">
        import {ELSA} from "../../core/elsaEntry.js";
        import {PAGE_MODE} from "../../common/const.js";

        const graphId = "dynamic-form-demo graph";
        window.onload = async () => {
            document.getElementById("loadFormData").addEventListener("click", () => {
                const graph = window.g;
                const form = graph.activePage.shapes[0];
                const json = window.testStore.get();
                form.loadJSON(json);
            });

            document.getElementById("serializeForm").addEventListener("click", () => {
                const graph = window.g;
                window.persistData = graph.activePage.shapes[0].persist();
                console.log(window.persistData);
            });

            document.getElementById("deSerializeForm").addEventListener("click", async () => {
                const graph = window.g;
                await graph.activePage.loadForm(window.persistData);
            });

            document.getElementById("clearPage").addEventListener("click", async () => {
                const graph = window.g;
                await graph.activePage.clear();
            });

            document.getElementById("runtime").addEventListener("click", async () => {
                const graph = window.g;
                const runtimePage = graph.addPage("runtimePage");
                runtimePage.mode = PAGE_MODE.RUNTIME;
                runtimePage.loadForm(window.persistData);
            });

            const store = () => {
                const self = {};

                self.get = () => {
                    return self.json;
                };

                self.store = (json) => {
                    self.json = json;
                };

                return self;
            };

            window.testStore = store();

            ELSA.newGraph(graphId, "fromGraph", document.getElementById("main"))
                .then(async agent => {
                    agent.openCollaboration();
                    const g = agent._graph;
                    window.g = g;
                    g.import('/fit/portal/fit-elsa/plugins/dynamicForm/form.js')
                        .import('/fit/portal/fit-elsa/plugins/dynamicForm/formPage.js')
                        .then(shapes => {
                            const p = g.addPage("dynamic form demo");

                            let form = p.createNew("form", 200, 50);
                            form.height = 350;
                            // const loadJsonFunc = function (page, shape) {
                            //     const form = shape.getForm();
                            //     const json = window.testStore.get();
                            //     form.loadJSON(json);
                            // }
                            // form.formLoadedCode = loadJsonFunc.toString();

                            let d0 = p.createNew("htmlDiv", 210, 60);
                            d0.container = form.id;
                            d0.height = 70;

                            let input = p.createNew("htmlOneLineText", 210, 140);
                            input.container = d0.id;
                            p.reset();

                            const data = p.serialize();
                            console.log(JSON.stringify(data));
                        });

                });
        };

    </script>
</head>

<body>
<div>
    <button id="loadFormData">loadFormData</button>
    <button id="serializeForm">serializeForm</button>
    <button id="deSerializeForm">deSerializeForm</button>
    <button id="clearPage">clearPage</button>
    <button id="runtime">runtime</button>
</div>
<div id="main" style="width:1600px; height: 1200px;position: absolute;"></div>
<div id="point" style="width:6px; height: 6px;position: absolute;left:397px;top:397px;background-color: brown;">
</div>

</body>

</html>