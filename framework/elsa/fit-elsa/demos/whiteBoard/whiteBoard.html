<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>白板测试</title>
    <script type="module">

        import {ELSA} from '../../core/graph.js';
        import {ALIGN, DOCK_MODE, PROGRESS_STATUS} from '../../common/const.js';

        const selectorWidth = 100;
        let writeArea = null;

        let loadGraph = async () => {
            await ELSA.import('../../plugins/whiteBoard/whiteBoard.js', ["whiteBoard"]);
            let g = ELSA.whiteBoard(document.getElementById("editor"), "HUA WEI - E.L.S.A");

            g.id = "code-competition";
            // g.baseUrl = "http://200.50.2.68:8080";
            // g.baseUrl = "http://10.174.54.196:8080";
            g.baseUrl = "http://elsa.fit.lab.huawei.com:8080";

            // g.setting.countdownSeconds = undefined;
            g.fullScreenCancelled = (id) => {
                const page = g.edit(g.getPageIndex(id));
                page.startAnimation();
                page.invalidate();
            };
            g.initialize()
                .import('/core/others.js')
                .import('../../plugins/mind/mind.js')
                .import('../../plugins/mind/topic.js')
                .import('../../plugins/mind/subTopic.js')
                .import('../../plugins/whiteBoard/whiteBoard.js', ['whiteBoardPage', 'writeArea'])
                .then(shapes => {
                    let page = g.addPage("whiteBoard");
                    page.dockMode = DOCK_MODE.VERTICAL;
                    page.itemSpace = 0;
                    page.id = "xiafei-white-page";

                    const wholeArea = createWholeArea(page);
                    createSelectorArea(page, wholeArea, window.innerHeight - 100);
                    writeArea = createWriteArea(page, wholeArea);
                    createOperationArea(page, writeArea);

                    page.reset();
                    page.startAnimation();
                    window.Interact = page.interactDrawer.getInteract();
                });
            return g;
        };
        window.onload = () => {
            loadGraph();
        }

        let setSelectedShape = shape => {
            if (writeArea) {
                writeArea.setSelectedShape(shape);
            }
        }

        function createWholeArea(page) {
            const wholeArea = page.createNew('container', 0, 0);
            wholeArea.id = "wholeArea";
            wholeArea.width = window.innerWidth;
            wholeArea.height = window.innerHeight - 100;
            wholeArea.dockMode = DOCK_MODE.HORIZONTAL;
            wholeArea.borderWidth = 0;
            wholeArea.editable = false;
            wholeArea.cornerRadius = 0;
            wholeArea.container = page.id;
            wholeArea.itemSpace = 0;
            wholeArea.invalidate();
            return wholeArea;
        }

        function createOperationArea(page, writeArea) {
            const operationArea = page.createNew('container', 0, window.innerHeight - 100);
            operationArea.id = "operationArea";
            operationArea.width = window.innerWidth;
            operationArea.height = 100;
            operationArea.selectable = false;
            operationArea.editable = false;
            operationArea.borderWidth = 0;
            operationArea.backColor = '#D3D3D3';
            operationArea.cornerRadius = 0;
            operationArea.invalidate();

            const writableBtn = page.createNew("rectangle", window.innerWidth - 300, window.innerHeight - 80);
            writableBtn.id = "writable";
            const state = {
                none: {
                    text: '启用手写', next: 'write'
                }, write: {
                    text: '禁用手写', next: 'none'
                }
            }
            writableBtn.width = 100;
            writableBtn.height = 40;
            writableBtn.text = state[writeArea.writeMode].text;
            writableBtn.moveable = false;
            writableBtn.editable = false;
            writableBtn.serializable = false;
            writableBtn.hAlign = ALIGN.MIDDLE;
            writableBtn.vAlign = ALIGN.MIDDLE;
            writableBtn.click = () => {
                writeArea.writeMode = state[writeArea.writeMode].next;
                writableBtn.text = state[writeArea.writeMode].text;
                writableBtn.invalidate();
            }

            const clearBtn = page.createNew("rectangle", window.innerWidth - 180, window.innerHeight - 80);
            clearBtn.id = "clear";
            clearBtn.width = 100;
            clearBtn.height = 40;
            clearBtn.text = "清空画板";
            clearBtn.moveable = false;
            clearBtn.editable = false;
            clearBtn.serializable = false;
            clearBtn.hAlign = ALIGN.MIDDLE;
            clearBtn.vAlign = ALIGN.MIDDLE;
            clearBtn.pad = 0;
            clearBtn.click = () => {
                writeArea.clear();
            }

            let createColorSelector = (page, operationArea, x, y, r, color, borderColor) => {
                if (!borderColor) {
                    borderColor = color;
                }
                const whitePencilWrapper = page.createNew('ellipse', x, y);
                whitePencilWrapper.id = "pencilWrapper" + color;
                whitePencilWrapper.width = r;
                whitePencilWrapper.height = r;
                whitePencilWrapper.backColor = '#EEEEEE';
                whitePencilWrapper.focusBackColor = '#EEEEEE';
                whitePencilWrapper.borderColor = borderColor;
                whitePencilWrapper.borderWidth = 0;
                whitePencilWrapper.backAlpha = null;
                whitePencilWrapper.selectable = false;
                whitePencilWrapper.moveable = false;
                whitePencilWrapper.hideText = true;
                whitePencilWrapper.serializable = false;
                whitePencilWrapper.invalidate();

                const diff = 5;
                const whitePencil = page.createNew('ellipse', x + diff, y + diff);
                whitePencil.id = "pencil" + color;
                whitePencil.width = r - diff * 2;
                whitePencil.height = r - diff * 2;
                whitePencil.container = operationArea.id;
                whitePencil.backColor = color;
                whitePencil.focusBackColor = color;
                whitePencil.borderColor = borderColor;
                whitePencil.backAlpha = 1;
                whitePencil.text = '';
                whitePencil.moveable = false;
                whitePencil.selectable = false;
                whitePencil.serializable = false;
                whitePencil.invalidate();
                return {wrapper: whitePencilWrapper, pencil: whitePencil};
            }

            let colors = ['white', 'red', '#98F80C', 'blue', 'yellow'];
            let colorSelectors = [];
            let margin = 150;
            let x = (window.innerWidth - margin * colors.length) / 2;

            colors.forEach(color => {
                const whiteColorSelector = createColorSelector(page, operationArea, x, window.innerHeight - 80, 50, color);
                colorSelectors.push(whiteColorSelector);
                x = x + margin;
            })

            colorSelectors[0].wrapper.backAlpha = 0.5;
            colorSelectors[0].wrapper.borderWidth = 1;

            colorSelectors.forEach(selector => {
                selector.pencil.click = () => {
                    selector.wrapper.backAlpha = 0.5;
                    selector.wrapper.borderWidth = 1;
                    selector.wrapper.invalidate();
                    writeArea.writeMode = 'write';
                    writeArea.changeHandDrawingConfig({color: selector.pencil.backColor})
                    colorSelectors.forEach(other => {
                        if (other.pencil.id !== selector.pencil.id) {
                            other.wrapper.backAlpha = null;
                            other.wrapper.borderWidth = 0;
                            other.wrapper.invalidate();
                        }
                    })
                }
            })
        }

        function createSelectorArea(page, container, height) {

            function addSelectorWrapper(page, shapeCreator, container, width, height, dockMode) {
                const wrapper = page.createNew("container", 0, 0);
                wrapper.height = height + 2;
                wrapper.container = container;
                wrapper.backAlpha = 0;
                wrapper.backColor = 'transparent';
                wrapper.borderWidth = 0;
                wrapper.editable = false;
                wrapper.cornerRadius = 0;
                if (!dockMode) {
                    wrapper.dockMode = DOCK_MODE.FILL;
                } else {
                    wrapper.dockMode = dockMode;
                }
                const pad = (wrapper.width - width) / 2;
                wrapper.itemPad = [pad, pad, 0, 0];
                const shape = shapeCreator(page, wrapper);
                shape.id = "selector_" + shape.type;
                shape.container = wrapper.id;
                shape.serializable = false;
                wrapper.id = "selectorWrapper_" + shape.type;
                shape.invalidate();
                shape.editable = false;
                shape.moveable = false;
                shape.dragable = false;
                shape.click = () => {
                    setSelectedShape(shape);
                }
                wrapper.click = () => {
                    setSelectedShape(shape);
                }
                return shape;
            }

            const selectorArea = page.createNew("container", 0, 0);
            const leftMargin = 10;
            selectorArea.id = "selectorArea";
            selectorArea.width = selectorWidth;
            selectorArea.height = height;
            selectorArea.backColor = "#DDDDDD"
            selectorArea.itemSpace = 25;
            selectorArea.container = container.id;
            selectorArea.dockMode = DOCK_MODE.VERTICAL;
            // const left = page.createNew("svg", 100, 200);
            // const left = page.createNew("container", 100, 200);

            let selectableShapes = [];

            const leftTitle = page.createNew("text", 0, 0);
            leftTitle.id = "leftTitle";
            leftTitle.text = "请选择图形";
            leftTitle.width = selectorWidth - 2 * leftMargin;
            leftTitle.height = 40;
            leftTitle.container = selectorArea.id;

            let lineCreator = (page, wrapper) => {
                const line = page.createNew("line", wrapper.x, wrapper.y);
                line.id = "rectangle";
                line.borderColor = "black";
                line.backColor = selectorArea.backColor;
                line.focusBackColor = "whitesmoke";
                line.text = "";
                line.borderWidth = 3;
                line.width = 60;
                line.height = 30;
                line.onShapePlaced = (newShape, area) => {
                    newShape.beginArrowSize = 10;
                    newShape.endArrowSize = 10;
                    newShape.backColor = area.backColor;
                    newShape.focusBackColor = area.backColor;
                    newShape.borderColor = "black";
                    newShape.focusBorderColor = "black";
                    newShape.width = 200;
                    newShape.height = 160;
                    newShape.text = "";
                }
                line.copyProperties = ['borderColor', 'borderWidth'];
                return line;
            }
            selectableShapes.push(addSelectorWrapper(page, lineCreator, selectorArea.id, 70, 50, DOCK_MODE.NONE))

            let rectangleCreator = (page, wrapper) => {
                const rectangle = page.createNew("rectangle", wrapper.x, wrapper.y);
                rectangle.id = "rectangle";
                rectangle.borderColor = "black";
                rectangle.backColor = selectorArea.backColor;
                rectangle.focusBackColor = "whitesmoke";
                rectangle.text = "";
                rectangle.borderWidth = 3;
                rectangle.onShapePlaced = (newShape, area) => {
                    newShape.backColor = area.backColor;
                    newShape.focusBackColor = area.backColor;
                    newShape.borderColor = "black";
                    newShape.focusBorderColor = "black";
                    newShape.mouseInColor = "whitesmoke";
                    newShape.width = 210;
                    newShape.height = 180;
                    newShape.text = "";
                }
                rectangle.copyProperties = ['borderColor', 'borderWidth'];
                return rectangle;
            }
            selectableShapes.push(addSelectorWrapper(page, rectangleCreator, selectorArea.id, 64, 48))

            let ellipseCreator = (page, wrapper) => {
                const ellipse = page.createNew("ellipse", wrapper.x, wrapper.y);
                ellipse.id = "ellipse";
                ellipse.borderColor = "black";
                ellipse.backColor = selectorArea.backColor;
                ellipse.focusBackColor = "whitesmoke";
                ellipse.text = "";
                ellipse.borderWidth = 2;
                ellipse.onShapePlaced = (newShape, area) => {
                    newShape.backColor = area.backColor;
                    newShape.focusBackColor = area.backColor;
                    newShape.borderColor = "black";
                    newShape.focusBorderColor = "black";
                    newShape.mouseInColor = "whitesmoke";
                    newShape.width = 210;
                    newShape.height = 180;
                    newShape.text = "";
                }
                ellipse.copyProperties = ['borderColor', 'borderWidth'];
                return ellipse;
            }
            selectableShapes.push(addSelectorWrapper(page, ellipseCreator, selectorArea.id, 56, 48))

            let logoCreator = (page, wrapper) => {
                const logo1 = page.createNew("image", wrapper.x, wrapper.y);
                logo1.id = "logo1";
                logo1.src = "../storageCompetition/images/left.png";
                logo1.onShapePlaced = (newShape) => {
                    newShape.emphasized = true;
                    newShape.width = 140;
                    newShape.height = 200;
                }
                logo1.copyProperties = ['src'];
                return logo1;
            }
            selectableShapes.push(addSelectorWrapper(page, logoCreator, selectorArea.id, 40, 60))

            let svgCreator = (page, wrapper) => {
                const svg = page.createNew("svg", wrapper.x, wrapper.y);
                svg.id = "svg";
                svg.onShapePlaced = (newShape) => {
                    newShape.emphasized = true
                    newShape.width = 150;
                    newShape.height = 150;
                }
                svg.copyProperties = ['width', 'height'];
                return svg;
            }
            selectableShapes.push(addSelectorWrapper(page, svgCreator, selectorArea.id, 50, 50))

            let videoCreator = (page, wrapper) => {
                const video = page.createNew("video", wrapper.x, wrapper.y);
                video.id = "video";
                video.backAlpha = 1;
                video.backColor = 'black';
                // video. = 'orange';
                video.src = 'testView.mp4';
                video.playControl.click = (x, y) => {
                    video.click(x, y);
                }
                video.onShapePlaced = (newShape) => {
                    newShape.focusBackColor = 'black';
                    newShape.width = 400;
                    newShape.height = 300;
                }
                video.copyProperties = ['backAlpha', 'backColor', 'src'];
                return video;
            }

            selectableShapes.push(addSelectorWrapper(page, videoCreator, selectorArea.id, 56, 48))

            let timerCreator = (page, wrapper) => {
                const timer = page.createNew("timer", wrapper.x, wrapper.y);
                timer.id = "timer";
                timer.fontColor = "black";
                timer.backColor = 'black';
                // timer.borderColor = 'black';
                // timer.focusBorderColor = 'black';
                timer.backAlpha = 1;
                timer.onShapePlaced = (newShape) => {
                    newShape.width = 240;
                    newShape.height = 100;
                    newShape.fontColor = "whitesmoke";
                    newShape.backColor = 'whitesmoke';
                    newShape.backAlpha = 1;
                    newShape.focusBorderColor = 'whitesmoke';
                    newShape.borderColor = 'whitesmoke';
                    newShape.mouseInColor = "black";
                }
                return timer;
            }
            selectableShapes.push(addSelectorWrapper(page, timerCreator, selectorArea.id, 80, 33))

            let calculatorCreator = (page, wrapper) => {
                const calculator = page.createNew("calculator", wrapper.x, wrapper.y);
                calculator.id = "calculator";
                calculator.text = "计算器";
                calculator.fontSize = 14;
                calculator.hAlign = ALIGN.MIDDLE;
                // calculator.vAlign = ALIGN.MIDDLE;
                calculator.hideText = false;
                calculator.onShapePlaced = (newShape) => {
                    newShape.width = 400;
                    newShape.height = 600;
                    newShape.borderColor = "whitesmoke";
                    newShape.borderWidth = 2;
                    newShape.backColor = 'whitesmoke';
                }
                return calculator;
            }
            selectableShapes.push(addSelectorWrapper(page, calculatorCreator, selectorArea.id, 80, 40))

            let mindCreator = (page, wrapper) => {
                const mind = page.createNew("mind", wrapper.x, wrapper.y);
                mind.id = "mind";
                mind.addDetection(['width'], (a, b, c) => {
                    console.log(a, b, c);
                })
                mind.text = "脑图";
                mind.hideText = false;
                mind.selectable = false;
                mind.backAlpha = 1;
                mind.getShapes()[0].x = 0;
                mind.getShapes()[0].y = 40;
                mind.getShapes()[0].height = 30;
                mind.getShapes()[0].padTop = 20;
                mind.getShapes()[0].text = "脑图";
                mind.getShapes()[0].selectable = false;
                mind.getShapes()[0].click = (x, y) => {
                    mind.click(x, y);
                }
                mind.width = 80;
                mind.height = 80;
                mind.invalidate();
                mind.onShapePlaced = newShape => {
                    newShape.width = 300;
                    newShape.height = 150;
                    let topic1 = newShape.getShapes().find(s => s.isType('topic'));
                    topic1.text = "E.L.S.A";
                    let sub1 = topic1.createTopic("subTopic");
                    sub1.parent = topic1.id;
                    sub1.text = "for document";
                    sub1.borderColor = sub1.fontColor = "steelblue";
                    sub1.priority = 2;
                    sub1.progressStatus = PROGRESS_STATUS.DOING;
                    let sub3 = topic1.createTopic("subTopic");
                    sub3.parent = topic1.id;
                    sub3.text = "for presentation";
                    sub3.borderColor = sub3.fontColor = "darkred";
                    sub3.emphasized = true;
                    sub3.priority = 1;
                    sub3.progressStatus = PROGRESS_STATUS.RUNNING;
                    let sub2 = topic1.createTopic("subTopic");
                    sub2.parent = topic1.id;
                    sub2.text = "for data table";
                    sub2.borderColor = sub2.fontColor = "darkgreen";
                    sub2.priority = 3;
                    sub2.progressStatus = PROGRESS_STATUS.UNKNOWN;
                    let sub9 = topic1.createTopic("subTopic");
                    sub9.parent = topic1.id;
                    sub9.text = "for drawing...";
                    sub9.priority = 1;
                    sub9.progressStatus = PROGRESS_STATUS.COMPLETE;
                }
                return mind;
            }
            // selectableShapes.push(addSelectorWrapper(page, mindCreator, selectorArea.id, 80, 80))

            // selectableShapes.forEach(selector => {
            //   selector.click = () => {
            //     selectedShape = selector;
            //     console.log(selector.id);
            //   }
            // })
            selectorArea.editable = false;
        }

        function createWriteArea(page, wholeArea) {
            const writeArea = page.createNew('writeArea', 0, 0);
            writeArea.id = "writeArea";
            writeArea.width = wholeArea.width - selectorWidth;
            writeArea.height = window.innerHeight - 100;
            writeArea.editable = false;
            writeArea.cornerRadius = 0;
            writeArea.backColor = "#666666";
            writeArea.container = wholeArea.id;
            writeArea.invalidate();
            return writeArea;
        }

    </script>
    <style type=text/css>
        .container {
            width: 100%;
            position: absolute;
            overflow-y: scroll;
            height: 100%;
        }
    </style>
</head>
<body>
<div id='editor' class='container'></div>
</body>
</html>
