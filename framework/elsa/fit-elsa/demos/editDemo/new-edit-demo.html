<!--
  ~ Copyright (c) Huawei Technologies Co., Ltd. 2023-2023. All rights reserved.
  -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>elsa</title>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
        }
    </style>
    <script type="module" language="javascript">
        import {ELSA} from "../../core/elsaEntry.js";
        import {LINEMODE} from "../../common/const.js";
        import {dataCommand} from "../../core/commands.js";
        import {uuid} from "../../common/util.js";

        const pageData = '{"id":"elsa-page:12345","type":"page","setting":{},"backColor":"whitesmoke","text":"--","editable":true,"dirty":false,"shapes":[{"id":"a47ztr","x":50,"y":200,"width":100,"height":100,"borderWidth":6,"text":"rectangle","container":"elsa-page:12345","type":"rectangle","visible":true,"index":100,"dirty":true},{"id":"ogpz2g","x":200,"y":200,"width":100,"height":100,"text":"container","borderColor":"red","container":"elsa-page:12345","type":"container","hideText":true,"visible":true,"index":101,"itemPad":[6,6,6,6],"itemSpace":5,"dirty":true},{"id":"3z15ad","x":50,"y":50,"width":100,"height":100,"text":"","backColor":"transparent","focusBackColor":"transparent","container":"elsa-page:12345","type":"vector","enableAnimation":true,"visible":true,"index":102,"originWidth":100,"originHeight":100,"drawDynamicCode":"function (context, width, height, global, shape) {\\r\\n        let drawArc = (angle, context, self, width) => {\\r\\n            context.beginPath();\\r\\n            context.fillStyle = \\"red\\";// self.getBorderColor();\\r\\n            context.lineWidth = 3;\\r\\n            context.moveTo(0, 0);\\r\\n            context.arc(0, 0, width / 4, angle, angle + 0.15 * Math.PI);\\r\\n            context.closePath();\\r\\n            context.fill();\\r\\n        };\\r\\n        const r = 12, step = Math.PI / 200;\\r\\n        (!global.degree) && (global.degree = 0);\\r\\n        context.save();\\r\\n        context.rotate(global.degree);\\r\\n\\r\\n        drawArc(0, context, self, width);\\r\\n        drawArc((1 / 3) * Math.PI, context, self, width);\\r\\n        drawArc((2 / 3) * Math.PI, context, self, width);\\r\\n        drawArc(1 * Math.PI, context, self, width);\\r\\n        drawArc((4 / 3) * Math.PI, context, self, width);\\r\\n        drawArc((5 / 3) * Math.PI, context, self, width);\\r\\n        context.restore();\\r\\n        global.degree -= step;\\r\\n        if (global.degree <= -Math.PI * 2) {\\r\\n            global.degree = 0;\\r\\n        }\\r\\n\\r\\n    }","dirty":true},{"id":"70lkur","x":50,"y":350,"width":50,"height":50,"backAlpha":1,"globalAlpha":1,"borderWidth":0,"text":"","borderColor":"silver","focusBorderColor":"silver","backColor":"red","focusBackColor":"transparent","container":"elsa-page:12345","type":"star","enableAnimation":true,"visible":true,"index":103,"originWidth":50,"originHeight":50,"drawDynamicCode":"function (context, width, height, global, shape) {\\r\\n        let drawArc = (angle, context, self, width) => {\\r\\n            context.beginPath();\\r\\n            context.fillStyle = \\"red\\";// self.getBorderColor();\\r\\n            context.lineWidth = 3;\\r\\n            context.moveTo(0, 0);\\r\\n            context.arc(0, 0, width / 4, angle, angle + 0.15 * Math.PI);\\r\\n            context.closePath();\\r\\n            context.fill();\\r\\n        };\\r\\n        const r = 12, step = Math.PI / 200;\\r\\n        (!global.degree) && (global.degree = 0);\\r\\n        context.save();\\r\\n        context.rotate(global.degree);\\r\\n\\r\\n        drawArc(0, context, self, width);\\r\\n        drawArc((1 / 3) * Math.PI, context, self, width);\\r\\n        drawArc((2 / 3) * Math.PI, context, self, width);\\r\\n        drawArc(1 * Math.PI, context, self, width);\\r\\n        drawArc((4 / 3) * Math.PI, context, self, width);\\r\\n        drawArc((5 / 3) * Math.PI, context, self, width);\\r\\n        context.restore();\\r\\n        global.degree -= step;\\r\\n        if (global.degree <= -Math.PI * 2) {\\r\\n            global.degree = 0;\\r\\n        }\\r\\n\\r\\n    }","dirty":true}]}';
        const graphId = "blank-00024-graph";
        window.onload = async () => {
            const dom = document.getElementById("stage");
            ELSA.setRepo({
                getGraph: () => {
                }, saveGraph: () => {
                }, getSession: () => {
                    return {name: "huizi", id: uuid(), time: (new Date()).toDateString()};
                }
            });
            const g = await ELSA.editGraph(graphId, "presentation", dom);
            // const g = await ELSA.editGraph(graphId, "graph", dom);
            window.graphAgent = g;
            if (g._graph.pages.length > 0) {
                g.openCollaboration();

                const len = g._graph.pages.length;
                await g.editPage(g._graph.pages[len - 1].id, dom);
                const page = g._graph.activePage;
                page.reset();
            } else {
                const page = g._graph.addPage();
                // page.mode = PAGE_MODE.DISPLAY;
                // const rectangle = page.createNew("rectangle", 100, 100);
                // rectangle.text = "123";
                page.createNew("start", 100, 100);
                page.createNew("event", 500, 500);
                page.createNew("line", 300, 100);
                page.reset();
            }

            document.getElementById("addRectangle").addEventListener("mousedown", e => {
                e.preventDefault();
                g.want("rectangle");
            });

            document.getElementById("addContainer").addEventListener("mousedown", e => {
                e.preventDefault();
                g.want("container");
            });

            document.getElementById("addLine").addEventListener("mousedown", e => {
                e.preventDefault();
                g.want("line");
            });

            document.getElementById("addBrokenLine").addEventListener("mousedown", e => {
                g.want("line", {
                    lineMode: LINEMODE['BROKEN'],
                    fontColor: "#000",
                    borderColor: "#686868",
                    focusBorderColor: "#686868",
                    mouseInBorderColor: "#686868"
                });
            });

            document.getElementById("toBrokenLine").addEventListener("mousedown", e => {
                e.preventDefault();
                const shapes = g._graph.activePage.getFocusedShapes();
                shapes.filter(s => s.isTypeof("line")).forEach(l => {
                    l.lineMode = LINEMODE.BROKEN;
                });
            });

            document.getElementById("setDescription").addEventListener("mousedown", e => {
                e.preventDefault();
                const shapes = g._graph.activePage.getFocusedShapes();
                shapes[0].graph.change(() => {
                    doCommand(shapes[0], getChangedData(shapes[0], "1111", "description"));
                })
            });

            document.getElementById("createEvent").addEventListener("mousedown", e => {
                e.preventDefault();
                g.want("event");
            });

            document.getElementById("createState").addEventListener("mousedown", e => {
                e.preventDefault();
                g.want("state");
            });

            document.getElementById("clear").addEventListener("mousedown", e => {
                e.preventDefault();
                g._graph.activePage.clear();
            });

            document.getElementById("undo").addEventListener("mousedown", e => {
                e.preventDefault();
                g._graph.getHistory().undo(g._graph.activePage);
            });

            document.getElementById("redo").addEventListener("mousedown", e => {
                e.preventDefault();
                g._graph.getHistory().redo(g._graph.activePage);
            });

            const getChangedData = (shape, value, field) => {
                let data = {shape: shape};
                if (field === 'conditionRule' && !/'{{.*?}}'/.test(value)) {
                    return [data];
                }
                if (field === 'task' && !/{{.*?}}/.test(value.owner)) {
                    data.shape.task.owner = '';
                    return [data];
                }
                data[field] = value;
                return [data];
            }

            const doCommand = (shape, changedData) => {
                dataCommand(shape.page, changedData).execute();
            }
        }
    </script>


</head>

<body style="zoom: 1">
<div>
    <button id="addRectangle">添加矩形</button>
    <button id="addContainer">添加容器</button>
    <button id="addLine">添加线</button>
    <button id="addBrokenLine">添加折线</button>
    <button id="toBrokenLine">变成折线</button>
    <button id="setDescription">设置description</button>
    <button id="createEvent">创建event</button>
    <button id="createState">创建state</button>
    <button id="clear">清屏</button>
    <button id="undo">撤销</button>
    <button id="redo">重做</button>
</div>
<div style="transform: scale(1, 1);">
    <div id="stage" style="position: absolute;width: 100%;height: 100vh;margin: 0 auto;"></div>
</div>
</body>

</html>