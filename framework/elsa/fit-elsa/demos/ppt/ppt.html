<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script type="module">
        import {ELSA} from "../../core/elsaEntry.js";
        import {uuid} from "../../common/util.js";
        import {LINEMODE} from "../../common/const.js";

        const graphId = "blank-00024-graph";

        window.onload = async () => {
            ELSA.setRepo({
                getGraph: () => {
                }, saveGraph: () => {
                }, getSession: () => {
                    return {name: "huizi", id: uuid(), time: (new Date()).toDateString()};
                }
            });

            const canvasDom = document.getElementById("canvas");
            const agent = await ELSA.editGraph(graphId, "presentation", canvasDom);
            window.agent = agent;
            if (agent._graph.pages.length > 0) {
                agent.openCollaboration();

                const len = agent._graph.pages.length;
                await agent.editPage(agent._graph.pages[len - 1].id, canvasDom);
                const page = agent._graph.activePage;
                page.reset();
                displayPage(page.id);
            } else {
                const page = agent._graph.addPage();
                page.serialize();

                // 展示当前页的缩略图.
                displayPage(page.id);
            }

            addToolbarEvent();
        };

        const createThumbDom = (pageId) => {
            const displayDom = document.createElement("div");
            displayDom.id = "thumb-" + pageId;
            displayDom.style.position = "absolute";
            displayDom.style.width = "380px";
            displayDom.style.height = "200px";
            displayDom.style.pointerEvents = "none";
            return displayDom;
        };

        const displayPage = (pageId) => {
            const displayContainerDom = document.createElement("div");
            displayContainerDom.style.width = "380px";
            displayContainerDom.style.height = "200px";
            const displayDom = createThumbDom(pageId);
            displayDom.style.top = ((agent._graph.pages.length - 1) * 200 + (agent._graph.pages.length - 1) * 10) + "px";
            displayContainerDom.appendChild(displayDom);
            document.getElementById("pagePanel").appendChild(displayContainerDom);

            // 点击切换主页面.
            displayContainerDom.addEventListener("click", () => {
                window.agent.editPage(pageId);
            });
            agent.displayPage(pageId, displayDom);
        };

        const addToolbarEvent = () => {
            document.getElementById("addPage").addEventListener("click", (e) => {
                const page = agent._graph.addPage();
                page.serialize();

                // 展示当前页的缩略图.
                displayPage(page.id);
            });

            document.getElementById("presentBtn").addEventListener("click", (e) => {
                agent.present(0);
            });

            document.getElementById("addRectangle").addEventListener("click", (e) => {
                window.agent.want("rectangle");
            });
            document.getElementById("addEllipse").addEventListener("click", (e) => {
                window.agent.want("ellipse");
            });

            document.getElementById("addContainer").addEventListener("click", (e) => {
                const container = window.agent._graph.activePage.createNew("container", 300, 200);
                container.width = 200;
                container.height = 200;
                container.invalidate();
            });

            document.getElementById("addLine").addEventListener("mousedown", e => {
                window.agent.want("line");
            });

            document.getElementById("addState").addEventListener("mousedown", e => {
                window.agent.want("state");
            });

            document.getElementById("addJadeNode").addEventListener("mousedown", e => {
                const jadeNode = window.agent._graph.activePage.createNew("jadeNode", 100, 100);
                jadeNode.height = 100;
                jadeNode.width = 100;
                jadeNode.invalidate();
            });


            document.getElementById("addBrokenLine").addEventListener("mousedown", e => {
                window.agent.want("line", {
                    lineMode: LINEMODE['BROKEN'],
                    fontColor: "#000",
                    borderColor: "#686868",
                    focusBorderColor: "#686868",
                    mouseInBorderColor: "#686868"
                });
            });
        };
    </script>
</head>
<body>
<div id="main">
    <div id="toolbar">
        <button id="addPage">新增一页</button>
        <button id="presentBtn">present</button>
        <button id="addRectangle">添加矩形</button>
        <button id="addContainer">添加容器</button>
        <button id="addEllipse">添加椭圆</button>
        <button id="addLine">添加线</button>
        <button id="addBrokenLine">添加折线</button>
        <button id="addJadeNode">添加jadeNode</button>
        <button id="addState">添加state</button>
    </div>
    <div id="stage">
        <div id="pagePanel" style="position:absolute; top: 40px; width: 400px;height: 500px"></div>
        <div id="canvas"
             style="position: absolute;left:400px;top:40px;width:1700px;height: 950px;margin: 0 auto;"></div>
    </div>
</div>
</body>
</html>