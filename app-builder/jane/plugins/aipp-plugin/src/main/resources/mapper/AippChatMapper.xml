<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huawei.fit.jober.aipp.mapper.AippChatMapper">
    <resultMap id="BaseResultMap" type="com.huawei.fit.jober.aipp.dto.chat.QueryChatRsp">
        <result column="chat_id" property="chatId"/>
        <result column="app_id" property="appId"/>
        <result column="app_version" property="version"/>
        <result column="name" property="chatName"/>
        <result column="attrbutes" property="msgId"/>
    </resultMap>

    <sql id="Base_Column_List">
        chat_id, app_id, app_version, name, attributes, create_at, create_by, update_at, update_by, status
    </sql>

    <insert id="insertChat" parameterType="com.huawei.fit.jober.aipp.entity.ChatInfo">
        insert into t_chat_session (chat_id, app_id, app_version, name, attributes, create_at, create_by, update_at, update_by, status)
        values (#{chatId}, #{appId}, #{version}, #{chatName}, #{attributes}::jsonb, #{createTime}, #{creator}, #{updateTime}, #{updater}, #{status})
        ON CONFLICT(chat_id) DO UPDATE SET
                         update_at = #{updateTime},
                         update_by = #{updater},
                         name = #{chatName},
                        attributes = #{attributes}::jsonb
    </insert>

    <insert id="insertWideRelationship" parameterType="com.huawei.fit.jober.aipp.entity.ChatAndInstanceMap">
        insert into t_chat_session_task_instance_wide_relationship (msg_id, chat_id, task_instance_wide_id, create_at, create_by, update_at, update_by)
        values (#{msgId}, #{chatId}, #{instanceId}, #{createTime}, #{creator}, #{updateTime}, #{updater})
    </insert>

    <select id="selectChatList"
            resultType="com.huawei.fit.jober.aipp.dto.chat.QueryChatRsp">
        select
        chat_id as chatId,
        name as chatName,
        attributes as msgId,
        app_id as appId,
        app_version as version,
        update_at as updateTime
        from t_chat_session
        where 1=1
        <if test="requestParam != null and requestParam.appId!=null">
            and app_id = #{requestParam.appId}
        </if>
        <if test="requestParam != null and requestParam.appVersion!=null">
            and app_version = #{requestParam.appVersion}
        </if>
        <if test="chatId!=null">
            and chat_id = #{chatId}
        </if>
        and status != 1
        order by update_at desc
        offset #{requestParam.offset} limit #{requestParam.limit}
    </select>

    <select id="selectChat" resultType="com.huawei.fit.jober.aipp.dto.chat.ChatDto">
        select a.msg_id as msgId,
               b.log_type as logType,
               b.create_at as createTime,
               b.log_data as logData,
               b.aipp_id as aippId
        from t_chat_session_task_instance_wide_relationship a
                 join aipp_instance_log b
                      on a.task_instance_wide_id = b.instance_id
        where a.chat_id = #{chatId}
        order by b.create_at desc
        offset #{offset} limit #{limit}
    </select>

    <update id="deleteApp">
        update t_chat_session
        set status = 1
        where app_id = #{appId}
    </update>

    <update id="deleteChat">
        update t_chat_session
        set status = 1
        where chat_id = #{chatId}
    </update>

    <select id="selectInstanceByChat" resultType="string">
        select task_instance_wide_id
        from t_chat_session_task_instance_wide_relationship
        where chat_id = #{chatId}
        order by create_at desc
        offset 0 limit #{limit}
    </select>

    <select id="selectMsgByInstance" resultType="string">
        select log_data
        from aipp_instance_log
        where instance_id = #{instanceId}
          and log_type = 'MSG'
    </select>

    <select id="countChat" resultType="int">
        select count(*)
        from t_chat_session_task_instance_wide_relationship
        where chat_id = #{chatId}
    </select>

    <select id="selectChatByAppId" resultType="string">
        select chat_id
        from t_chat_session
        where app_id = #{appId}
        and attributes -> 'originApp' IS NULL
        order by create_at desc
        offset 0 limit #{count}
    </select>

    <select id="selectChatIdByInstanceId" resultType="string">
        select chat_id
        from t_chat_session_task_instance_wide_relationship
        where task_instance_wide_id = #{instanceId}
    </select>

    <delete id="deleteWideRelationshipByInstanceId">
        delete
        from t_chat_session_task_instance_wide_relationship
        where task_instance_wide_id = #{instanceId}
    </delete>
</mapper>